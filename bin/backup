#!/usr/bin/env sh

set -e

to_dir=/media/jfriesen/Backup
from_dir=$HOME
while getopts 'fht' opt; do
    case "$opt" in
    f)
        from_dir=$2
        shift 2
      ;;
    t)
        to_dir=$2
        shift 2
      ;;
    h)
        echo "Usage: $(basename $0) \\\\\n\t[-t /path/to/backup-media] \\\\\n\t[-f /path/from/which/to/copy]"
        exit 2
        ;;
    ?)
    echo "Invalid command option.\nUsage: $(basename $0) \\\n\t[-t /path/to/backup-media] \\\n\t[-f /path/from/which/to/copy] \\\n\t[-h]"
    exit 2
esac
done

if [ ! -d $to_dir ]; then
    echo "Missing $to_dir directory" >&2
    exit 2
fi

if [ ! -d $from_dir]; then
    echo "Missing $from_dir directory" >&2
    exit 2
fi

if command -v rsync > /dev/null; then
    rsync $from_dir $to_dir \
          --progress --delete-excluded -aiz \
          --exclude=jfriesen/.cache \
          --exclude=jfriesen/go \
          --exclude=jfriesen/.brew \
          --exclude=jfriesen/.emacs.d/straight \
          --exclude=jfriesen/.bundle \
          --exclude=jfriesen/.librewolf \
          --exclude=jfriesen/.mullvad-browser \
          --exclude=jfriesen/.mozilla \
          --exclude=jfriesen/.local \
          --exclude=jfriesen/.rbenv \
          --exclude=*/tmp \
          --exclude=*/._tmp \
          --exclude=*/*.tmp \
          --exclude=*/*.log

    echo "Wrote backup to $to_dir"
else
    echo "Missing rsync command" >&2
    exit 1
fi
