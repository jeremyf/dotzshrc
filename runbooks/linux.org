#+TITLE: Linux

This is my runbook for Linux.  It contains Org-Mode tangle blocks.[fn:1] My goal is
that once I have Emacs installed, I can “execute” this document to perform many
of the updates.

* Guiding Principles

I have chosen to adopt Linux in an effort to step out of a walled garden; namely
MacOS.  I have been using MacOS as my personal and work operating system
since 2005.  In that time, I’ve watched as Apple has become more hostile to
folks using their computer outside the bounds of “Applications made by folks
that have paid Apple for the privilege of making Applications in MacOS.”

Some of this includes:

- Requiring XCode to build software
- Marking installed packages as “damaged” when they weren’t signed by Apple.

Further, Apple is rolling out “Artificial Intelligence” which means my
computering may well be used for training a Large Language Model (LLM).  As
such, I’m looking to step out of the walled garden.

I’m also looking at how I might use this experience to guide others.  This
“guide others” is in tension with my exploration of a a tiling window manager;
in that the managers I’m considering are a bit more obtuse compared to current
desktop interactions.

Running contrary to this, is the fact that for the foreseeable future, I’ll be
using MacOS for my work environment.  Which means I’m looking to maintain
degrees of similarity.

* Keyboard Bindings

Given that my work computer is a Mac and I'm shifting to Linux, I know
that I will bump up against keybinding differences.

I consider the most important key change to be mapping my =caps lock= key to =ctrl=.
All other things are negotiable.  I’m also considering whether I will remap even
more keys.

I do know that for my window manager, I want to explore mapping an under-used
key.

The computer I'm using has a firmware package for modifying keybindings; however
I'm opting for a more general approach.  That is one that doesn't need a
firmware package.  Which should be generally more applicable.

One significant difference, shifting from a Macbook keyboard and my new machine
is that I now have a number pad along with several “good ol’ stand-by keys” such
as Print Screen, Insert, Page Up/Down, Home, and End.

** Editing =/etc/default/keyboard=

As part of my initial effort to map =caps lock= to =ctrl=, I used the following:

- Open a Shell
- Switch to root (e.g. =su=)
- Edit =/etc/default/keyboard=
- Set ~XKBOPTIONS="ctrl:swapcaps"~
- Run =sudo dpkg-reconfigure keyboard-configuration=
- Restart the computer

This worked, but was more invasive than I wanted.  So I explored XModmap as an
alternative.

** XModmap

I am unclear about the interaction of XModmap and =/etc/default/keyboard=; as such
I removed the changes I made to the keyboard file and proceeded with these
steps.[fn:3]

I found [[https://gist.github.com/yemM/9f232e2483b67965e9a0d55158e02ab2][Xmodmap to get keyboard act as on Mac OS · GitHub]], which altered the
keyboard layout to similar expectations as MacOS.  However I'm going with a
slightly different configuration

#+begin_src text :tangle ~/.Xmodmap
  !!! NOTE: This file was generated by org-tangle from
  !!!       ~/git/dotzshrc/runbooks/linux.org

  ! As a matter of hygiene and cleanliness, clear the modifiers.  We will remap
  ! later.
  clear lock
  clear control
  clear mod1
  clear mod2
  clear mod3
  clear mod4
  clear mod5

  ! Bind left control as Hyper
  keycode 37 = Hyper_L

  !Bind caps lock as Control
  keycode 66 = Control_L

  !Bind insert as Hyper_R
  !keycode 118 = Hyper_R

  add control = Control_L Control_R
  add mod1 = Alt_L Alt_R Meta_L
  add mod2 = Num_Lock
  add mod3 = Hyper_L
  add mod4 = Super_L Super_R
  ! Treat re-bound insert as mod5 in Terminal
  ! add mod5 = Hyper_R
#+end_src

On my present machine the bottom key labels are (from left to right) and with
the above configuration these bind accordingly:

- =ctrl= :: =C-=
- =fn= :: OS Function key toggle (e.g. =F1=)
- =super= :: =s-=
- =alt= :: =M-=
- =space= :: =SPC=
- =alt= :: =M-=
- =menu= :: =M-x= (kind of nice having a dedicated =M-x= key)
- =ctrl= :: =C-=

In my initial foray, I bound =Insert/Screen Lock= key to =H-= (hyper).  A major
change that I'm evaluating is whether the keys to the immediate right and left
of =SPC= should be =M-= or =s-=.  There is also the left-most =ctrl= that I might remap.

However, this binding conflicted with later developments, so I preserved =Insert=
as its original behavior.

Regardless of my considerations, I use the following command to apply the above
changes:

#+begin_src bash :results none
  xmodmap ~/.Xmodmap
#+end_src

I’ve attempted to add this keyboard configuration to my windowed session login;
however it is not yet working.  As such, whenever I boot my computer and login,
it behooves me to launch a terminal.

* Coping with Pop OS Keybindings

This was a bit of a side-quest, but one that relates to Emacs.  Namely Pop OS
uses a lot of =s-= keys for window operations.  My Emacs also uses =s-= keys, and I
wanted to avoid collision.

Out of the box, I’m using Pop OS.  I had considered Debian, but when I use a
live boot image, the trackpad does not work.  I’m not prepared to mess with
this.  So I’m sticking with the quite nice Pop OS (a derivative of Ubuntu, which
is a derivative of Debian).

There are a lot of OS-level keys bound to =s-= prefix.  I went through the menu to
disable most of those.

One non-Pop OS key was monitor switching.  It was bound to =s-p=, something I use
extensively in Emacs.  I ran =gsettings set org.gnome.mutter.keybindings
switch-monitor "[]"= to unbind =s-p= from the =switch-monitor= gnome command.

I'm also using =dconf dump / > ~/git/dotzshrc/pop_os_settings.conf= which I can
then use to load, via the following:

#+begin_src shell :dir "/home/jfriesen" :cache no :export source :results raw silent
  dconf load < ~/git/dotzshrc/pop_os_settings.conf
#+end_src

What I noticed is that the =dconf dump= does not include the default keybindings,
but instead the changes.  To find those, I needed to dig just a bit further.

TODO: I referenced the Pop OS schema.

One at present unsolvable is that typing =s-= and releasing invokes Pop OS’s
launcher.  Given that I’d often used =s-Space= for MacOS to launch apps, I’m okay
enough with this behavior.

And as I’ve been working on Linux, to build this document, I opted to switch the
bindings on my Macbook.  Now the key to the left of the spacebar on my Macbook
maps to Option/Alt.  I figure, if I’m going to leave the wall garden perhaps I
can also leave the muscle memory and rebuild anew.

* Get Emacs Installed

That’s a lot of pre-amble for “Caps Lock sends Control character.”  Now, on to
getting the primary tool of my computering: Emacs.

I think my Emacs configuration requires at least version 29.1; however I’m
uncertain.  The package manager had Emacs 27 available, so I opted to build from
source.

I could either download a released version’s source code or clone the
repository.  I chose the clone route; as this would be useful as upgrades come
out.

Preliminaries:

#+begin_src shell :dir "/sudo::/" :cache no :export source :results raw silent
  sudo apt update && sudo apt install git --assume-yes
#+end_src

With =git= installed I need a copy of the Emacs repository, and should build from
a stable ref; as of <2025-04-23 Wed> that is =emacs-30.1=.[fn:6]

I used [[https://gist.github.com/zoliky/0445b20676bfa85450d7df006066ceb7][Installing Emacs 29.1 from source on Debian 12 · GitHub]] as my framing.

- =sudo apt build-dep emacs=
- =sudo apt install libtree-sitter-dev=
- =sudo apt install libgcc-12-dev libgccjit-12-dev=
- =mkdir ~/.local/emacs=

In my source directory for Emacs (e.g., =~/git/emacs/=), I ran the following:

#+begin_example bash
  ./configure \
  --prefix="$HOME/.local/emacs/" \
  --without-compress-install \
  --with-native-compilation=aot \
  --with-x \
  --with-x-toolkit=lucid \
  --with-gif \
  --with-png \
  --with-jpeg \
  --with-tiff \
  --with-imagemagick \
  --with-mailutils \
  --with-tree-sitter \
  CC=gcc-12
#+end_example

It took a few tries, which is why I have the ~CC=gcc-12~ declaration as well as
instructions for installing =libgcc-12-dev= and =libgccjit-12-dev=.

Now came time to spin up the fans.  I ran =make -j 16=; where 16 is the number of
cores on my machine.  And finally =make install=.

Along the way, I realized that there were terminal commands that I was missing.
But I could hobble along.

Up until I had Emacs built, I was using =nano= to write my notes.  It is quite
serviceable.

Note, I could have installed Emacs 30.1 via the Pop Shop, however I chose to
build from source.

** Grabbing Links

Part of my writing workflow is grabbing links from my browser (and RSS feed).
On MacOS I use [[https://github.com/xuchunyang/grab-mac-link.el][GitHub - xuchunyang/grab-mac-link.el: Grab link from Mac Apps and
insert it into Emacs]].  And I explored [[https://github.com/xuchunyang/grab-x-link][GitHub - xuchunyang/grab-x-link: Grab
links from some X11 apps and insert into Emacs]].

However, that wasn’t quite enough.  So I wrote up [[https://github.com/jeremyf/dotemacs/blob/943ba0640db5526d5946ec094ab7a4f2d32cfb9b/emacs.d/grab-x-link.el][some changes for my own needs]];
namely to address having multiple applications based on Firefox.  Along the way
I learned about =xdotool= and =comm=.

** Toggling Gnome Settings

There are a few settings that I have found useful to toggle:

- [[*Trackpad][Trackpad]]
- [[*Night Light][Night Light]]
- [[*Light/Dark Theme][Light/Dark Theme]]
- [[*Radios][Radios]]

I wanted [[*Emacs Commands][Emacs Commands]] setup to help quickly toggle each of these.

*** Trackpad

With my new laptop and how I hold my hands, I’ve noticed that sometimes I
activate my trackpad.  Which is annoying, especially when I’m in a “writing
mindset.”

*** Night Light

I don’t like the bright blues of a normal screen.  Instead I prefer to use a
display setting that softens the colors.  In MacOS this is “Night Shift.”

I choose a much warmer color, knowing that reds are softer on the retina.[fn:7]

*** Light/Dark Theme

Related but different from the [[*Night Light][Night Light]] concept is the Light and Dark
theming.  In Emacs I had a script to toggle the theme of both the OS and Emacs
(e.g. my =jf/dark= function).  I wanted something similar in Linux.

Yet, as I explored the changes, I realized that there would be a divergence in
implementation based on MacOS or Linux.

*** Radios

By default, I like to keep my Bluetooth off.  I wanted a way to turn this off
and on via Emacs.  And also turn off and on my WiFi.

*** TODO Emacs Commands

With the toggles identified, I set about writing the functions and macros to
help with future needs.

* Internet Hygiene

I installed my password manager, so I could quickly sign-in to paid services.  I
downloaded [[https://mullvad.net][Mullvad VPN]] and reviewed the base-line configuration.  Then set my
DNS following the [[https://mullvad.net/en/help/dns-over-https-and-dns-over-tls#linux][DNS Over HTTPs and DNS over TLS]] instruction.

With Firefox shifting from an advertising funded Browser company to an
advertising AI company that makes a browser, I’m wanting to separate from day to
day usage.

Finding useful the [[https://github.com/mullvad/mullvad-browser/issues/1][Github Issue “What differentiates Mullvad Browser from, for
instance, arkenfox's user.js or Librewolf?”]], I have chosen to install both.

For LibreWolf:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo apt update && sudo apt install extrepo  --assume-yes

  sudo extrepo enable librewolf

  sudo apt update && sudo apt install librewolf --assume-yes
#+end_src

For Mullvad Browser:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo curl -fsSLo /usr/share/keyrings/mullvad-keyring.asc https://repository.mullvad.net/deb/mullvad-keyring.asc

  # Add the Mullvad repository server to apt
  echo "deb [signed-by=/usr/share/keyrings/mullvad-keyring.asc arch=$( dpkg --print-architecture )] https://repository.mullvad.net/deb/stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/mullvad.list

  # Install the package
  sudo apt update
  sudo apt install mullvad-browser --assume-yes
#+end_src

* Terminal

In MacOS I’ve long used iTerm2, which is a terminal available only in MacOS.  I
have started using the Vterm package in Emacs, but still want a non-Emacs based
option.

The built in terminal is adequate, but I’m thinking about using a cross-platform
terminal.  The top contenders are Alacritty and Kitty.  Normally I’d favor
Kitty, but my MacOS install of Kitty has some weird behavior.

For now I’m holding.

* Authentication with Github

I’ve long used SSH keys for Github.

I needed to again create a token and get the [[https://github.com/cli/cli/blob/trunk/docs/install_linux.md][Github CLI command tool]] working.  I
did some tweaking to the command paths.

* General Tasks

Installed [[https://ohmyz.sh/][Oh My Zsh]] then set =zsh= as default shell via the following:

#+begin_src shell :dir "/home/jfriesen/" :cache no :export source :results raw silent
  chsh -s $(which zsh)
#+end_src

On MacOS I was using =~/.zprofile= for my shell configuration.  I needed to instead
use =~/.zshenv=.

I leverage =fzf= for my reverse history search in my shell (e.g. =ctrl= + =r=), so I
installed it via the following:

#+begin_src shell :dir "/sudo::/home/jfriesen/" :cache no :export source :results raw silent
  sudo apt install fzf --assume-yes
#+end_src

Curious how to get completions and key-bindings working, I ran =apt info fzf=
which pointed me to to the following:

#+begin_quote
Refer /usr/share/doc/fzf/README.Debian for quick instructions on how to add
keybindings for Bash, Zsh, Fish to call fzf.
#+end_quote

I leverage =fd= as a =find= alternative, I ran: =sudo apt install fd-find
--assume-yes=.  However, for the Consult package this version was inadequate.

So I downloaded a more recent [[https://github.com/sharkdp/fd/releases][release of fd]] and ran the following:

#+begin_example
  sudo dpkg --force all -i ~/Downloads/fd-musl_10.2.0_amd64.deb
#+end_example

Then following instructions, I created the symlink as follows:

#+begin_src shell :dir "/home/jfriesen/" :cache no :export source :results raw silent
  ln -sf $(which fdfind) ~/.local/bin/fd
#+end_src

In MacOS I regularly use =pbcopy= and =pbpaste=.  Both =xclip= and =xsel= apparently
provide similar behavior.  I opted to install both via the following:

#+begin_src shell :dir "/sudo::/home/jfriesen/" :cache no :export source :results raw silent
  sudo apt install xclip xsel --assume-yes
#+end_src

* Keyboard Navigation

I’m accustomed to MacOS, in which many basic Emacs key navigations work.  I
wanted to make that happen, I found [[https://blog.karssen.org/2024/06/05/using-emacs-key-bindings-in-gnome-firefox-and-other-applications/][Using Emacs Key bindings in Gnome, Firefox,
and other Applications]].

I ran the following:

#+begin_src shell :cache no :export source :results raw silent
  gsettings set org.gnome.desktop.interface gtk-key-theme 'Emacs'
#+end_src

This helps, but I’d still love for =C-n= to send =Down= when typed in non-Emacs;
this is something that I used Karabiner Elements to enforce/provide.

* Menu Bar

I'm using the Pop OS flavor of Ubuntu; and wanted to enable the application
Menu.  I ran the following:

#+begin_src shell :cache no :export source :results raw silent
  gsettings set org.gnome.shell.extensions.pop-cosmic show-application-menu true
#+end_src

* Window Tiling

I’m curious about tiling window managers.  And seeing how I can introduce some
friction for changing contexts.[fn:4] I acknowledge that shifting from long-time
use of MacOS to Linux is likely already a major disruption, and layering on
changes to window management may be overwhelming.

But, I figure this is a good time to learn.  I settled on [[https://i3wm.org/][I3]] as my initial
tiling window manager.  [[https://i3wm.org/][I3]] is well-documented, was simple to install and get
running.[fn:5]

On my old Macbook and work laptop (both running MacOS), I installed [[https://github.com/nikitabobko/AeroSpace][AeroSpace]]
and am practicing that using a [[https://github.com/jeremyf/dotzshrc/blob/main/symlinks/dot.aerospace.toml][custom configuration]].  My hope is to have some
hotkey alignment on my work machine and personal machine(s).

During this exploration, I’ve considered the following tiling window managers:

- Exwm :: it runs within Emacs; but am hesitant to bind my tiling window manager
  to the single-threaded Emacs.
- XMonad :: it is built in Haskell; the installation process seemed a bit more
  arduous.
- Ratpoison :: a minimal, no dependency, window manager that seeks to minimize
  mouse usage.  This feels like “computering from a by-gone era.”
- StumpWM :: a Lisp reimagining of Ratpoison, with notable Emacs integration.

In each of the above cases, the adoption curve was higher.  I’m also considering
that as I adopt a tiling window manager, I’ll be learning new computering
approaches as I shift from MacOS to Linux.  So I figure, adopt something that is
simple to use.

During my exploration, I learned of some key functions:

- =update-alternatives= :: I can use this command to =--install= or =--remove= an
  option.

I appreciate that I have the ability to install the window manager package but
not install it as the active window manager.  And I can install multiple window
manager packages, but only activate one of them.

** On I3

A configurable and well-documented tiling window manager.  I performed the
following steps to get it running:

- =sudo apt install i3=
- =sudo update-alternatives --install /usr/bin/x-session-manager x-session-manager /usr/bin/i3 60=

To remove i3 as my window manager of choice I ran:

=sudo update-alternatves --remove x-session-manager /usr/bin/i3=

*** I3 Config

What follows is my [[https://i3wm.org/][I3]] config:

#+begin_src text :tangle ~/.config/i3/config
  # NOTE: This file was generated by org-tangle from
  #       ~/git/dotzshrc/runbooks/linux.org
  #
  # This file began its existence as the output of i3-config-wizard.  Since then
  # it has underwent modifications.
  #
  # Its present form is that of a an i3 config file (v4)
  #
  # Please see https://i3wm.org/docs/userguide.html for a complete reference!

  # I'm looking at mapping Mod5 to one of those "old-timey" keys that wasn't
  # available on a Mac (e.g. "print screen", "insert", etc.)
  #
  # This lets my Emacs keybindings remain untouched.
  set $mod Mod5

  # Emacs is the core of my computering.  The command, as written is not
  # adequate, but it is a good place-holder.
  exec --no-startu-id emacs ~/

  # Font for window titles. Will also be used by the bar unless a different font
  # is used in the bar {} block below.
  font pango:monospace 8

  # This font is widely installed, provides lots of unicode glyphs, right-to-left
  # text rendering and scalability on retina/hidpi displays (thanks to pango).
  #font pango:DejaVu Sans Mono 8

  # Start XDG autostart .desktop files using dex. See also
  # https://wiki.archlinux.org/index.php/XDG_Autostart
  exec --no-startup-id dex --autostart --environment i3
  
  # https://wiki.archlinux.org/index.php/XDG_Autostart
  exec --no-startup-id dex --autostart --environment i3

  # The combination of xss-lock, nm-applet and pactl is a popular choice, so
  # they are included here as an example. Modify as you see fit.

  # xss-lock grabs a logind suspend inhibit lock and will use i3lock to lock the
  # screen before suspend. Use loginctl lock-session to lock your screen.
  exec --no-startup-id xss-lock --transfer-sleep-lock -- i3lock --nofork

  # NetworkManager is the most popular way to manage wireless networks on Linux,
  # and nm-applet is a desktop environment-independent system tray GUI for it.
  exec --no-startup-id nm-applet

  # Use pactl to adjust volume in PulseAudio.
  set $refresh_i3status killall -SIGUSR1 i3status
  bindsym XF86AudioRaiseVolume exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ +10% && $refresh_i3status
  bindsym XF86AudioLowerVolume exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ -10% && $refresh_i3status
  bindsym XF86AudioMute exec --no-startup-id pactl set-sink-mute @DEFAULT_SINK@ toggle && $refresh_i3status
  bindsym XF86AudioMicMute exec --no-startup-id pactl set-source-mute @DEFAULT_SOURCE@ toggle && $refresh_i3status

  # Use Mouse+$mod to drag floating windows to their wanted position
  floating_modifier $mod

  # move tiling windows via drag & drop by left-clicking into the title bar,
  # or left-clicking anywhere into the window while holding the floating modifier.
  tiling_drag modifier titlebar

  # Kill and relaunch Emacs
  mode "exec" {
    bindsym e exec "edaemon; e ~/ -c"
    bindsym l exec "librewolf"
    bindsym m exec "mullvad"
    # bindsym v exec "vpn"
    bindsym t exec i3-sensible-terminal

    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+x mode "default"
  }
  bindsym $mod+x mode "exec"

  # kill focused window
  bindsym $mod+Shift+q kill

  # start a program launcher
  # TODO: explore rofi https://wiki.archlinux.org/title/Rofi
  bindsym $mod+space exec --no-startup-id dmenu_run

  # A more modern dmenu replacement is rofi:
  # bindcode $mod+40 exec "rofi -modi drun,run -show drun"
  # There also is i3-dmenu-desktop which only displays applications shipping a
  # .desktop file. It is a wrapper around dmenu, so you need that installed.
  # bindcode $mod+40 exec --no-startup-id i3-dmenu-desktop

  mode "focus" {
    bindsym b focus left
    bindsym Left focus left

    bindsym n focus down
    bindsym Down focus down

    bindsym p focus up
    bindsym Up focus up

    bindsym f focus right
    bindsym Right focus right

    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+f mode "default"
  }
  bindsym $mod+f mode "focus"

  mode "move" {
    bindsym b move left
    bindsym Left move left

    bindsym n move down
    bindsym Down move down

    bindsym p move up
    bindsym Up move up

    bindsym f move right
    bindsym Right move right

    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+m mode "default"
  }
  bindsym $mod+m mode "move"

  mode "split" {
    bindsym h split h
    bindsym v split v

    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+s mode "default"
  }
  bindsym $mod+s mode "split"

  mode "layout" {
    bindsym f fullscreen toggle
    bindsym s layout stacking
    bindsym w layout tabbed
    bindsym e layout toggle split

    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+l mode "default"
  }
  bindsym $mod+l mode "layout"

  # toggle tiling / floating
  bindsym $mod+/ floating toggle

  # change focus between tiling / floating windows
  # bindsym $mod+shift+/ focus mode_toggle

  # focus the parent container
  #bindsym $mod+a focus parent

  # focus the child container
  #bindsym $mod+d focus child

  # Define names for default workspaces for which we configure key bindings later on.
  # We use variables to avoid repeating the names in multiple places.
  set $ws1 "1"
  set $ws2 "2"
  set $ws3 "3"
  set $ws4 "4"
  set $ws5 "5"
  set $ws6 "6"
  set $ws7 "7"
  set $ws8 "8"
  set $ws9 "9"
  set $ws10 "10"

  # switch to workspace
  bindsym $mod+1 workspace number $ws1
  bindsym $mod+2 workspace number $ws2
  bindsym $mod+3 workspace number $ws3
  bindsym $mod+4 workspace number $ws4
  bindsym $mod+5 workspace number $ws5
  bindsym $mod+6 workspace number $ws6
  bindsym $mod+7 workspace number $ws7
  bindsym $mod+8 workspace number $ws8
  bindsym $mod+9 workspace number $ws9
  bindsym $mod+0 workspace number $ws10

  # move focused container to workspace
  bindsym $mod+Shift+1 move container to workspace number $ws1
  bindsym $mod+Shift+2 move container to workspace number $ws2
  bindsym $mod+Shift+3 move container to workspace number $ws3
  bindsym $mod+Shift+4 move container to workspace number $ws4
  bindsym $mod+Shift+5 move container to workspace number $ws5
  bindsym $mod+Shift+6 move container to workspace number $ws6
  bindsym $mod+Shift+7 move container to workspace number $ws7
  bindsym $mod+Shift+8 move container to workspace number $ws8
  bindsym $mod+Shift+9 move container to workspace number $ws9
  bindsym $mod+Shift+0 move container to workspace number $ws10

  # reload the configuration file
  bindsym $mod+Shift+c reload
  # restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
  bindsym $mod+Shift+r restart
  # exit i3 (logs you out of your X session)
  bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -B 'Yes, exit i3' 'i3-msg exit'"

  # resize window (you can also use the mouse for that)
  mode "resize" {
    # These bindings trigger as soon as you enter the resize mode

    # Pressing left will shrink the window’s width.
    # Pressing right will grow the window’s width.
    # Pressing up will shrink the window’s height.
    # Pressing down will grow the window’s height.
    bindsym j resize shrink width 10 px or 10 ppt
    bindsym k resize grow height 10 px or 10 ppt
    bindsym l resize shrink height 10 px or 10 ppt
    bindsym semicolon resize grow width 10 px or 10 ppt

    # same bindings, but for the arrow keys
    bindsym Left resize shrink width 10 px or 10 ppt
    bindsym Down resize grow height 10 px or 10 ppt
    bindsym Up resize shrink height 10 px or 10 ppt
    bindsym Right resize grow width 10 px or 10 ppt

    # back to normal: Enter or Escape or $mod+r
    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+r mode "default"
  }

  bindsym $mod+r mode "resize"

  # Start i3bar to display a workspace bar (plus the system information i3status
  # finds out, if available)
  bar {
  status_command i3status --config ~/.config/i3/i3status.conf
  }

#+end_src

*** I3 Status Config

I found the default I3 status bar to be very chatty.  I stripped that down for
less chatter.

#+begin_src text :tangle ~/.config/i3/i3status.conf
  # NOTE: This file was generated by org-tangle from
  #       ~/git/dotzshrc/runbooks/linux.org
  general {
     colors = true
     interval = 5
  }

  order += "wireless wlan0"
  order += "disk /"
  order += "tztime local"
  order += "battery 0"
  order += "load"

  tztime local {
    format = "%Y-%m-%d %H:%M"
  }

  battery 0 {
    format = "%status %percentage %remaining %emptytime"
    format_down = "No battery"
    status_chr = "⚡ CHR"
    status_bat = "🔋 BAT"
    status_unk = "? UNK"
    status_full = "☻ FULL"
    path = "/sys/class/power_supply/BAT%d/uevent"
    low_threshold = 10
  }

  load {
    format = "%5min"
  }

  disk "/" {
    format = "%free"
  }
#+end_src

*** Considerations

I’m accustomed to a “system tray” in MacOS that includes actionable icons:

- VPN, which shows both status as well as allows for “clicking” to change.
- ProtonBridge, which shows the status of whether its running (and thus I can
  pull email from the server).
- Bluetooth indicator
- Logout button

I’m unclear how those icons might behave, or how I might assemble that using I3.

* TODO Outstanding Tasks [77%]

In this section I outline and detail the steps I consider for a complete
migration.

** DONE Hardening
CLOSED: [2025-04-29 Tue 22:13]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-29 Tue 22:13]
:END:

Enable automatic security updates:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo dpkg-reconfigure -p low unattended-upgrades
#+end_src

Disable some services, first run ~sudo systemctl list-unit-files --state=enabled~
to assess what services are running.

Below is an example of one of those:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo systemctl disable cups.service
#+end_src


** DONE Firewall
CLOSED: [2025-04-29 Tue 14:59]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-29 Tue 14:59]
:END:

From [[https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu][How to Set Up a Firewall with UFW on Ubuntu | DigitalOcean]], I'm going with
a baseline setup.  Though will look to refine.

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo ufw default deny incoming
  sudo ufw default allow outgoing
  sudo ufw enable
  sudo nmap localhost
  sudo ufw deny 139
  sudo ufw deny 161
  sudo ufw deny 5353
#+end_src

Where 139 is NETBIOS, 161 is SNMP, mDNS 5353, as per [[https://github.com/iAnonymous3000/popos-hardening-guide][GitHub -
iAnonymous3000/popos-hardening-guide]].  I’m sure there’s more to do, but for now
this is adequate.  However, there are refinements.

*** Open Snitch

The refining I'm thinking of is along the lines of MacOS’s Little Snitch (or
some alternative).  I didn’t use Little Snitch, favoring Lulu, but figure when
searching for alternatives, that Little Snitch is more known.

With a very baseline firewall in place, I set about finding a replacement.  The
first candidate is [[https://github.com/evilsocket/opensnitch][GitHub - evilsocket/opensnitch: OpenSnitch is a GNU/Linux
interactive application firewall inspired by Little Snitch]].

After downloading the files, I ran the following to install the Open Snitch
daemon:

#+begin_src shell :dir "/sudo::/home/jfriesen/Downloads/" :cache no :export source :results raw silent
  sudo apt install --assume-yes ./opensnitch*.deb
#+end_src

And the Open Snitch GUI:

#+begin_src shell :dir "/sudo::/home/jfriesen/Downloads/" :cache no :export source :results raw silent
  sudo apt install --assume-yes ./python3-opensnitch-ui*.deb
#+end_src

Along the way I learned about specifying =/sudo::/path/to/dir/= as the =:dir= option
for the shell.  This means I can run the command via =sudo= and babel will prompt
for my password.

Per the documentation, I needed to patch up my pip install with the following:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
sudo apt install --assume-yes python3-pip
#+end_src

#+begin_src shell :dir "/home/jfriesen" :cache no :export source :results raw silent
pip3 install grpcio==1.41.0
pip3 install protobuf==3.20.0
#+end_src

I then added Open Snitch to my running services via the following:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo systemctl enable --now opensnitch.service
#+end_src

Rather quickly, Little Snitch started asking me if I wanted to allow or block
connections.  There were some preliminary “allow forever” decisions that I
needed to make.

** DONE Clipboard Manager
CLOSED: [2025-04-30 Wed 15:55]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 15:55]
:END:

On MacOS, I’ve been using Maccy.  And as more and more of my computering moves
to Emacs, the clipboard manager has become less crucial.  However, having a
history is very nice.

As part of my research, I stumbled upon the [[https://copyq.readthedocs.io/en/latest/index.html][CopyQ’s documentation]]; a
cross-platform clipboard manager.  I decided to give this a go in Linux, and if
it works start using it on MacOS.

From the documentation I ran:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
sudo apt install software-properties-common
sudo add-apt-repository ppa:hluk/copyq
sudo apt update
sudo apt install copyq
#+end_src

With that installed, I was curious about how to ensure that CopyQ always
launched at login.  And there’s a settings in the preferences.

The primary function I wanted was to have a hot key that would provide a list of
paste options.  I bound =s-M-v= to CopyQ’s “Show the Menu Tray”; this gives me a
list of the last five copied items with the option to easily search for more.

CopyQ supports different themes; I wanted to keep the CopyQ theme synchronized
with the OS theme.

The following toggles the CopyQ theme based on the current state of my
workspace’s color scheme:

#+begin_src emacs-lisp
  (defun jf/linux:toggle-copyq-theme (&optional color-scheme)
      "Toggle the copyq theme based on current COLOR-SCHEME."
      (interactive)
      (let ((theme
              (if (eq :dark
                    (or color-scheme (jf/current-color-scheme-gnome)))
                "solarized-dark.ini"
                "solarized-light.ini"))
             (theme-dir
               (s-trim (shell-command-to-string "copyq info themes"))))
        (shell-command
          (concat "copyq loadTheme " (f-join theme-dir theme)))))
#+end_src

The above function is a proof of concept that I can then tie into my color
scheme toggling process (with modifications I’m sure).

** DONE Emacs Everywhere
CLOSED: [2025-04-29 Tue 08:24]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-29 Tue 08:24]
:END:

I use the [[https://github.com/tecosaur/emacs-everywhere][Emacs Everywhere package]].  On MacOS I rely on [[https://www.hammerspoon.org/][Hammerspoon]] tool for
launching into Emacs.

In short this package, copies the current input field (e.g. a browser’s
textarea) into a dedicated Emacs buffer, I then edit the text in Emacs, and when
done paste the content back into the input field.

I have found this quite useful as I’ve also chosen to set that dedicated Emacs
buffer to use a focused writing context; akin to Writeroom.

As I’m running Pop OS, I followed the [[https://help.ubuntu.com/stable/ubuntu-help/keyboard-shortcuts-set.html.en][Ubuntu instructions for binding a custom
shortcut]].

I also needed to ensure that =pandoc= is installed.  With that done, I ran =M-x
emacs-everywhere-check-health=.  However, I observed a problem that was only
evident when I read the source code.  Namely things didn’t work.

Why?  Because in an earlier incarnation of keybindings, I had bound the =Insert=
key to =Hyper_R=; and =emacs-everywhere= used that key code to perform the “paste”
of the initial text into Emacs.

So I needed to unbind that key.

Further, the [[https://help.ubuntu.com/stable/ubuntu-help/keyboard-shortcuts-set.html.en][Ubuntu instructions for binding a custom shortcut]] did not work.  I
then tried using =xbindkeys=.  I followed [[l][Make your own keybindings in linux using
xbindkeys]].

I installed xbindkeys via:

#+begin_src shell :dir "/sudo::/home/jfriesen/Downloads/" :cache no :export source :results raw silent
  sudo apt-get install --assume-yes xbindkeys
#+end_src

My hasty initial entry, which was what was recorded in the Pop OS shortcut, was
as follows:

#+begin_example
  "emacsclient --eval '(emacs-everywhere)'"
    Alt + Super + e
#+end_example

That did not work.  Following further instructions, I used =xbindkeys -k= to
determine how it interpreted =Alt= + =Super= + =e=.  Which resulted in
=Alt+Mod2+Mod4 + e=.

I updated my =.xbindkeysrc= to reflect the above.  And things started working.

** DONE Get SyncThing Running
CLOSED: [2025-04-30 Wed 22:00]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 22:00]
:END:

There are three parts to SyncThing:

- [[*Installing SyncThing][Installing SyncThing]]
- [[*Auto-Start SyncThing][Auto-Start SyncThing]]
- [[*Configuring SyncThing][Configuring SyncThing]]

In reviewing my setup, both [[*Elfeed with Existing Data][Elfeed with Existing Data]] and [[*Denote Files][Denote Files]] need data
from my old machine.  It makes sense to get SyncThing working, and pull that
information from my previous computer.

As a side quest, I want to use [[https://localsend.org/][LocalSend]] to get the Action ID of my SyncThing
instance on my old machine.

*** DONE Installing SyncThing
CLOSED: [2025-04-30 Wed 18:35]
:LOGBOOK:
- State "DONE"       from              [2025-04-30 Wed 18:35]
:END:

Following [[https://apt.syncthing.net/][Syncthing docs on installing on Debian/Ubuntu]] we have the following:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
  sudo mkdir -p /etc/apt/keyrings
  sudo curl -L -o /etc/apt/keyrings/syncthing-archive-keyring.gpg https://syncthing.net/release-key.gpg
#+end_src

And I’d rather use stable than candidate, so I need to add the keyring:

#+begin_src shell :dir "/sudo::/home/jfriesen" :cache no :export source :results raw silent
echo "deb [signed-by=/etc/apt/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable" | sudo tee /etc/apt/sources.list.d/syncthing.list
#+end_src

And with the repository installed, I set about installing SyncThing:

#+begin_src shell :dir "/sudo::/" :cache no :export source :results raw silent
  sudo apt-get update --assume-yes
  sudo apt-get install syncthing --assume-yes
#+end_src

And from that I’ll need to configure my local SyncThing.

*** DONE Auto-Start SyncThing
CLOSED: [2025-04-30 Wed 19:09]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 19:09]
:END:

Reading [[https://docs.syncthing.net/users/autostart.html#linux][Starting Syncthing Automatically]], I can add the =syncthring-start.desktop=
to my auto-start directions:

#+begin_src shell :dir "/home/jfriesen" :cache no :export source :results raw silent
  cp /usr/share/applications/syncthing-start.desktop ~/.config/autostart/
#+end_src

If this does not work, I can use =systemctl=.

*** DONE Configuring SyncThing
CLOSED: [2025-04-30 Wed 21:32]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 21:32]
:END:

This is beyond the scope of this document; though perhaps best identified in a
SyncThing runbook.  It involves setting up local directories and connecting to
other devices in my SyncThing “ring”.

** DONE Elfeed with Existing Data
CLOSED: [2025-04-30 Wed 21:59]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 21:59]
:END:

In [[https://takeonrules.com/2025/01/22/on-elfeed-and-backups/][On Elfeed and Backups]], I wrote about using Elfeed for my RSS reader.  I
restored the previous machine’s backup to my new machine.  And all things
worked; I had the old data and could fetch new information.

** DONE Denote Files
CLOSED: [2025-04-30 Wed 21:36]
:LOGBOOK:
- State "DONE"       from "TODO"       [2025-04-30 Wed 21:36]
:END:

For most all of my writing I use Org-Mode, leveraging Denote for its file naming
convention as well as utility functions.  Getting those files from my old
machine is one of the last steps.

I used SyncThing to bring things over.  And with those files I checked if my
Emacs functions worked.  This is when I found that the <2025-04-30 Wed>
installed version of =fd= was =v8.3.1=.  Which lead to the install instructions
above.

For the time being, I’m sync-ing files from my old machine to the new machine.
At some point, I’ll flip that.

** TODO Publish Blog Post

This requires setting up my build engine; which involves building Hugo and Ruby.

First is following some instructions around Ruby Environment (=rbenv=) manager.
Looking at package manager options, it appears that [[https://github.com/rbenv/rbenv?tab=readme-ov-file#basic-git-checkout][cloning is the best option]].

And I’ll need to [[https://gohugo.io/installation/linux/#prebuilt-binaries][either build Hugo from source or install a release version]].

** TODO Read and Compose Emails in Emacs

This is a lower priority, but one that I want to eventually want.  As such, I’m
deferring.

* Footnotes

[fn:7] My mom has a retinal disease and her research and recommendations from
experts leads her to incorporate more red filters in her day to day.

[fn:6] I had a copy of the Emacs git repository on another machine.  So I used the
sneaker net (e.g. a thumbdrive) to copy that over to the Linux machine and then
run =git pull= so I could get up to date source code.

[fn:1] Run =M-x org-babel-tangle= to perform the updates.

[fn:2] A consumer-grade older HP laptop.

[fn:3] An advantage is that the XModmap modifications, as implemented, are on a
per-user basis.

[fn:4] I’ve noticed that when I use =Cmd+Tab= to jump between applications I am just
a bit more prone to accept a distraction.  Also that I’m using this as some sort
of reflex to seek distraction.

[fn:5] [[https://i3wm.org/][I3]] was also the documentation that detailed =update-alternatives=; which
equipped me to further explore.
